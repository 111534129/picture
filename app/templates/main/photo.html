{% extends "base.html" %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div style="text-align: center; margin-bottom: 20px;">
        <img src="{{ url_for('static', filename='uploads/' + photo.filename) }}" alt="Photo"
            style="max-width: 100%; max-height: 80vh;">
    </div>

    <div class="meta" style="display: flex; justify-content: space-between; align-items: start;">
        <div>
            <p>上傳者： <strong><a href="{{ url_for('main.user', username=photo.uploader.username) }}">{{
                        photo.uploader.username }}</a></strong> 於 {{ photo.uploaded_at.strftime('%Y-%m-%d') }}</p>
            <p>所屬相簿： <a href="{{ url_for('main.album', id=photo.album.id) }}">{{ photo.album.title }}</a>
                <span style="font-size: 0.8em; color: gray; margin-left: 10px;">
                    {% if photo.album.privacy == 'public' %}(公開)
                    {% elif photo.album.privacy == 'private' %}(私密)
                    {% else %}(僅好友)
                    {% endif %}
                </span>
            </p>

            <!-- Like Section -->
            <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                {% if current_user.is_authenticated %}
                {% if current_user.has_liked_photo(photo) %}
                <form action="{{ url_for('main.unlike_photo', id=photo.id) }}" method="post" style="display: inline;">
                    <button type="submit" class="btn"
                        style="background-color: transparent; border: 1px solid #ffadad; color: #dc3545; display: flex; align-items: center; gap: 5px; padding: 5px 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                        </svg>
                        已按讚
                    </button>
                </form>
                {% else %}
                <form action="{{ url_for('main.like_photo', id=photo.id) }}" method="post" style="display: inline;">
                    <button type="submit" class="btn"
                        style="background-color: transparent; border: 1px solid #ddd; color: #555; display: flex; align-items: center; gap: 5px; padding: 5px 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                            </path>
                        </svg>
                        按讚
                    </button>
                </form>
                {% endif %}
                {% else %}
                <a href="{{ url_for('auth.login') }}" class="btn"
                    style="background-color: transparent; border: 1px solid #ddd; color: #555; display: flex; align-items: center; gap: 5px; padding: 5px 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                        </path>
                    </svg>
                    按讚
                </a>
                {% endif %}
                <span style="font-weight: bold;">{{ photo.likes.count() }} 人覺得讚</span>

                <!-- Set as Cover Button (Only for Author) -->
                {% if current_user == photo.album.author %}
                <form action="{{ url_for('main.set_album_cover', id=photo.album.id, photo_id=photo.id) }}" method="post"
                    style="display: inline; margin-left: 10px;">
                    <button type="submit" class="btn"
                        style="background-color: transparent; border: 1px solid #007bff; color: #007bff; padding: 5px 10px;">
                        設為封面
                    </button>
                </form>
                {% endif %}

                <!-- Download Button (Author or Allowed) -->
                {% if current_user == photo.album.author or photo.album.allow_download %}
                <a href="{{ url_for('main.download_photo', id=photo.id) }}" class="btn"
                    style="background-color: transparent; border: 1px solid #28a745; color: #28a745; display: inline-flex; align-items: center; gap: 5px; padding: 5px 10px; margin-left: 10px; text-decoration: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    下載原圖
                </a>
                {% endif %}

                <!-- Report Button (For everyone except author) -->
                {% if current_user.is_authenticated and current_user != photo.album.author %}
                <button onclick="document.getElementById('reportModal').style.display='block'" class="btn"
                    style="background-color: transparent; border: 1px solid #dc3545; color: #dc3545; display: inline-flex; align-items: center; gap: 5px; padding: 5px 10px; margin-left: 10px;">
                    檢舉
                </button>
                {% endif %}
            </div>

            {% if photo.tags or current_user == photo.uploader or current_user.role == 'admin' %}
            <div class="tags" style="margin-top: 15px; display: flex; align-items: center; flex-wrap: wrap; gap: 5px;">
                {% for tag in photo.tags %}
                <a href="{{ url_for('main.tag', name=tag.name) }}"
                    style="background-color: #e9ecef; color: #495057; text-decoration: none; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; display: inline-block;">
                    #{{ tag.name }}
                </a>
                {% endfor %}

                {% if current_user == photo.uploader or current_user.role == 'admin' %}
                <button onclick="document.getElementById('editTagsModal').style.display='block'"
                    style="background: none; border: 1px dashed #ccc; color: #888; cursor: pointer; padding: 2px 8px; border-radius: 15px; font-size: 0.8rem; margin-left: 5px;"
                    title="編輯標籤">
                    + 編輯標籤
                </button>
                {% endif %}
            </div>
            {% endif %}

            <!-- Edit Tags Modal -->
            <div id="editTagsModal"
                style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
                <div
                    style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 450px; border-radius: 8px;">
                    <span onclick="document.getElementById('editTagsModal').style.display='none'"
                        style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                    <h3>編輯照片標籤</h3>
                    <form action="{{ url_for('main.edit_photo_tags', id=photo.id) }}" method="post">
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="tagsInput">標籤（請用空格或 # 分隔）：</label>
                            <input type="text" name="tags" id="tagsInput" class="form-control"
                                value="{% for tag in photo.tags %}#{{ tag.name }} {% endfor %}"
                                placeholder="例如: #風景 #旅遊 #2024"
                                style="width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box;">
                        </div>
                        <div style="text-align: right; margin-top: 20px;">
                            <button type="button"
                                onclick="document.getElementById('editTagsModal').style.display='none'" class="btn"
                                style="background-color: #6c757d; color: white;">取消</button>
                            <button type="submit" class="btn"
                                style="background-color: #007bff; color: white; margin-left: 10px;">儲存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% if current_user == photo.album.author or current_user.role == 'admin' %}
        <div
            style="background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd; display: flex; flex-direction: column; gap: 10px;">
            {% if current_user == photo.album.author %}
            <form action="{{ url_for('main.update_album_privacy', id=photo.album.id) }}" method="post"
                style="display: flex; gap: 5px; align-items: center;">
                <label for="privacy" style="margin: 0; font-size: 0.9rem;">設定：</label>
                <select name="privacy" id="privacy" class="form-control"
                    style="padding: 2px 5px; width: auto; font-size: 0.9rem;">
                    <option value="public" {% if photo.album.privacy=='public' %}selected{% endif %}>公開</option>
                    <option value="shared" {% if photo.album.privacy=='shared' %}selected{% endif %}>僅好友</option>
                    <option value="private" {% if photo.album.privacy=='private' %}selected{% endif %}>私密</option>
                </select>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" name="allow_download" id="allow_download" {% if photo.album.allow_download
                        %}checked{% endif %}>
                    <label for="allow_download" style="margin: 0; font-size: 0.9rem;">允許下載</label>
                </div>
                <button type="submit" class="btn" style="padding: 2px 10px; font-size: 0.9rem;">修改</button>
            </form>
            {% endif %}

            <form action="{{ url_for('main.delete_photo', id=photo.id) }}" method="post"
                onsubmit="return confirm('確定要刪除這張照片嗎？');" style="align-self: flex-end;">
                <button type="submit" class="btn"
                    style="background-color: #dc3545; padding: 2px 10px; font-size: 0.9rem;">刪除照片 {% if
                    current_user.role == 'admin' %}(Admin){% endif %}</button>
            </form>
        </div>
        {% endif %}
    </div>

    <hr>

    <div class="comments">
        <h3>留言</h3>
        {% for comment in photo.comments if not comment.parent_id %}
        <div class="comment" style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <div style="display: flex; justify-content: space-between;">
                <div>
                    <strong>{{ comment.author.username }}</strong>: {{ comment.content | linkify_mentions | safe }}
                    <br><small style="color: grey;">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
                {% if current_user.is_authenticated %}
                <button onclick="toggleReplyForm('{{ comment.id }}', '{{ comment.author.username }}')" class="btn"
                    style="padding: 2px 5px; font-size: 0.8rem; height: fit-content;">回覆</button>
                {% endif %}
            </div>

            <!-- Replies -->
            <div style="margin-left: 30px; border-left: 2px solid #eee; padding-left: 10px;">
                {% for reply in comment.replies %}
                <div class="reply" style="margin-top: 10px;">
                    <strong>{{ reply.author.username }}</strong>: {{ reply.content | linkify_mentions | safe }}
                    <br><small style="color: grey;">{{ reply.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
                {% endfor %}
            </div>

            <!-- Reply Form (Hidden by default) -->
            <div id="reply-form-{{ comment.id }}" style="display: none; margin-top: 10px; margin-left: 30px;">
                <form action="{{ url_for('main.photo', id=photo.id, parent_id=comment.id) }}" method="post">
                    {{ form.hidden_tag() }}
                    <div class="form-group">
                        {{ form.content(class="form-control", placeholder="回覆...", rows=2) }}
                    </div>
                    {{ form.submit(class="btn", value="送出回覆") }}
                </form>
            </div>
        </div>
        {% else %}
        <p>目前沒有留言。</p>
        {% endfor %}
    </div>

    <div class="add-comment" style="margin-top: 20px;">
        {% if current_user.is_authenticated %}
        <h4>新增留言</h4>
        <form action="{{ url_for('main.photo', id=photo.id) }}" method="post">
            {{ form.hidden_tag() }}
            <div class="form-group">
                {{ form.content(class="form-control", placeholder="留言...", rows=2) }}
            </div>
            {{ form.submit(class="btn") }}
        </form>
        {% else %}
        <p>請 <a href="{{ url_for('auth.login') }}">登入</a> 以留言。</p>
        {% endif %}
    </div>
</div>

<script>
    function toggleReplyForm(commentId, username) {
        var form = document.getElementById('reply-form-' + commentId);
        if (form.style.display === 'none') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }
</script>

<!-- Report Modal -->
<div id="reportModal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div
        style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;">
        <span onclick="document.getElementById('reportModal').style.display='none'"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h2>檢舉內容</h2>
        <form action="{{ url_for('main.report_content') }}" method="post">
            <input type="hidden" name="type" value="photo">
            <input type="hidden" name="id" value="{{ photo.id }}">

            <div class="form-group">
                <label>請選擇檢舉理由：</label><br>
                <div style="margin-bottom: 10px;">
                    <input type="radio" id="r1" name="reason" value="色情或裸露內容" required>
                    <label for="r1">色情或裸露內容</label>
                </div>
                <div style="margin-bottom: 10px;">
                    <input type="radio" id="r2" name="reason" value="暴力或仇恨言論">
                    <label for="r2">暴力或仇恨言論</label>
                </div>
                <div style="margin-bottom: 10px;">
                    <input type="radio" id="r3" name="reason" value="騷擾或霸凌">
                    <label for="r3">騷擾或霸凌</label>
                </div>
                <div style="margin-bottom: 10px;">
                    <input type="radio" id="r4" name="reason" value="垃圾訊息或詐騙">
                    <label for="r4">垃圾訊息或詐騙</label>
                </div>
                <div style="margin-bottom: 10px;">
                    <input type="radio" id="r5" name="reason" value="其他" onchange="toggleOtherInput(this)">
                    <label for="r5">其他</label>
                    <input type="text" name="other_reason" id="otherReasonInput" class="form-control"
                        style="display:none; margin-top: 5px;" placeholder="請說明詳細檢舉原因...">
                </div>
            </div>

            <script>
                function toggleOtherInput(radio) {
                    var input = document.getElementById('otherReasonInput');
                    var radios = document.getElementsByName('reason');

                    // Reset all
                    radios.forEach(function (r) {
                        if (r.value !== '其他') {
                            r.addEventListener('change', function () {
                                input.style.display = 'none';
                                input.required = false;
                            });
                        }
                    });

                    if (radio.checked && radio.value === '其他') {
                        input.style.display = 'block';
                        input.required = true;
                    }
                }

                // Add listeners to other radios to hide input
                document.querySelectorAll('input[name="reason"]').forEach(function (r) {
                    r.addEventListener('change', function () {
                        var input = document.getElementById('otherReasonInput');
                        if (this.value !== '其他') {
                            input.style.display = 'none';
                            input.required = false;
                        } else {
                            input.style.display = 'block';
                            input.required = true;
                        }
                    });
                });
            </script>


            <div style="text-align: right; margin-top: 20px;">
                <button type="button" onclick="document.getElementById('reportModal').style.display='none'" class="btn"
                    style="background-color: #6c757d; color: white;">取消</button>
                <button type="submit" class="btn"
                    style="background-color: #dc3545; color: white; margin-left: 10px;">送出檢舉</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}