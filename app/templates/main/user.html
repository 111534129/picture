{% extends "base.html" %}

{% block content %}
<div
    style="max-width: 800px; margin: 0 auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 20px;">
            {% if user.avatar %}
            <img src="{{ url_for('static', filename='uploads/' + user.avatar) }}" alt="Avatar"
                style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #f8f9fa;">
            {% else %}
            <div
                style="width: 120px; height: 120px; border-radius: 50%; background-color: #ddd; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #777;">
                {{ user.username[0] | upper }}
            </div>
            {% endif %}
            <div>
                <h1 style="margin: 0; font-size: 2.5rem;">{{ user.username }}</h1>
                <p style="color: #666; margin: 5px 0 0;">{{ user.intro or "這位使用者很懶，還沒有自我介紹。" }}</p>
                <div style="margin-top: 10px; font-size: 0.95rem;">
                    <a href="{{ url_for('main.followers', username=user.username) }}"
                        style="margin-right: 15px; color: #333; text-decoration: none;">
                        <strong>{{ user.followers.count() }}</strong> 位追蹤者
                    </a>
                    <a href="{{ url_for('main.following', username=user.username) }}"
                        style="color: #333; text-decoration: none;">
                        <strong>{{ user.followed.count() }}</strong> 正在追蹤
                    </a>
                </div>
                <p style="color: #999; font-size: 0.9rem; margin-top: 5px;">加入時間： {{
                    user.created_at.strftime('%Y-%m-%d') }}</p>
            </div>
        </div>

        {% if user == current_user %}
        <a href="{{ url_for('main.edit_profile') }}" class="btn">編輯個人資料</a>
        {% elif current_user.is_authenticated %}
        {% if current_user.is_following(user) %}
        <a href="{{ url_for('main.unfollow', username=user.username) }}" class="btn"
            style="background-color: #dc3545;">取消追蹤</a>
        {% else %}
        <a href="{{ url_for('main.follow', username=user.username) }}" class="btn">追蹤使用者</a>
        {% endif %}
        {% endif %}
    </div>

    <hr style="margin: 30px 0;">

    <h2>{{ user.username }} 的相簿</h2>
    <div class="gallery"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
        {% for album in user.albums %}
        {% if album.privacy == 'public' or user == current_user or (album.privacy == 'shared' and
        current_user.is_authenticated and current_user.is_mutual_following(user)) %}
        <div class="album-card" style="border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">
            <a href="{{ url_for('main.album', id=album.id) }}" style="text-decoration: none; color: inherit;">
                <div
                    style="height: 150px; background-color: #eee; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    {% set cover = album.public_cover %}
                    {% if cover %}
                    <img src="{{ url_for('static', filename='uploads/' + cover.filename) }}"
                        style="width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                    <span style="color: #999;">無封面</span>
                    {% endif %}
                </div>
                <div style="padding: 10px;">
                    <h3 style="margin: 0 0 5px; font-size: 1.2rem;">{{ album.title }}</h3>
                    <p
                        style="margin: 0 0 10px; color: #666; font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ album.description }}</p>
                    <small>
                        {% if album.privacy == 'public' %}公開
                        {% elif album.privacy == 'private' %}私密
                        {% else %}僅好友
                        {% endif %}
                    </small>
                </div>
            </a>
        </div>
        {% endif %}
        {% else %}
        <p>尚無相簿。</p>
        {% endfor %}
    </div>

    <hr style="margin: 30px 0;">

    {% if user == current_user or
    user.liked_photos_privacy == 'public' or
    (user.liked_photos_privacy == 'shared' and current_user.is_authenticated and current_user.is_mutual_following(user))
    %}
    <h2>{{ user.username }} 按讚的照片</h2>
    <div class="gallery"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
        {% for like in user.liked_photos %}
        {% set photo = like.photo %}
        {# Permission Check Logic (Same as View Logic) #}
        {% if (photo.album.privacy == 'public'
        or current_user == photo.album.author
        or (photo.album.privacy == 'shared' and current_user.is_authenticated and
        current_user.is_mutual_following(photo.album.author))
        or (current_user.is_authenticated and current_user in photo.album.shared_users)) and not photo.is_banned
        %}
        <div class="photo-card" style="position: relative;">
            <a href="{{ url_for('main.photo', id=photo.id) }}">
                <img src="{{ url_for('static', filename='uploads/' + photo.filename) }}" alt="Photo"
                    style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px; transition: opacity 0.3s;"
                    onmouseover="this.style.opacity=0.8" onmouseout="this.style.opacity=1">
            </a>
        </div>
        {% endif %}
        {% else %}
        <p>尚無按讚的照片。</p>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}